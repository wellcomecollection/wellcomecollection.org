worker_processes 1;
events { worker_connections 1024; }

http {
  server {
    listen           80;
    listen           443 ssl;
    server_name      wellcomecollection.org;
    add_header       x-wc-nginx-proxy true;
    add_header       Strict-Transport-Security max-age=10886400;

    gzip on;
    gzip_types text/css application/javascript;
    # See: http://webmasters.stackexchange.com/questions/31750/what-is-recommended-minimum-object-size-for-gzip-performance-benefits
    gzip_min_length 860;
    gzip_proxied any;

    # These are the locations we know exist solely on v2
    location ~ ^/assets|/async|/explore|/works|/series|/preview|/articles/W|/exhibitions/W|/events/W {
      proxy_set_header        Host $host;
      proxy_pass              http://wellcomecollection:3000;
    }
    location ~ ^/management/.* {
      proxy_set_header        Host $host;
      proxy_pass              http://wellcomecollection:3000;
    }
    location /articles {
      proxy_set_header        Host $host;
      proxy_pass              http://wellcomecollection:3000;
    }

    # Everything else - if we 404 on v1, we fallback to v2
    location / {
      proxy_set_header        Host prev.wellcomecollection.org;
      proxy_set_header        HTTP_X_FORWARDED_PROTO https;
      proxy_pass              http://prev.wellcomecollection.org;
      proxy_intercept_errors  on;
      add_header              x-wc-invalid-location true;
      error_page 404 = @v2;
    }

    location @v1 {
      proxy_set_header        Host prev.wellcomecollection.org;
      proxy_set_header        HTTP_X_FORWARDED_PROTO https;
      proxy_pass              http://prev.wellcomecollection.org;
    }

    location @v2 {
      proxy_set_header        Host $host;
      proxy_pass              http://wellcomecollection:3000;
    }
  }

  # for now we just allow you through to the site
  #Â but we might want to always redirect to https://wellcomecollection.org
  server {
    listen      80 default_server;
    server_name _;
    add_header  x-wc-nginx-proxy true;

    location / {
      proxy_set_header Host $host;
      proxy_pass       http://wellcomecollection:3000;
    }
  }
}
