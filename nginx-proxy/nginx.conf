worker_processes 1;
events { worker_connections 1024; }

http {
  # Wordpress Blog deprecation
  server {
    listen      80;
    server_name blog.wellcomecollection.org;
    add_header  x-wc-nginx-proxy true;

    location ~* \/feed\/?$ {
      # we send the traffic over to the Wordpress servers, and the host, they then resolve correctly,
      # even though it's a proxy.
      proxy_pass https://192.0.78.12;
      proxy_set_header Host $host;
    }

    location ~* (?<!feed\/) {
      # articles
      rewrite ^/\d+\/\d+\/\d+\/(.*)/?$ https://wellcomecollection.org/articles/$1 permanent;

      # categories
      rewrite ^/category\/(.*)/?$ https://wellcomecollection.org/articles?q=categories:$1 permanent;

      # tags
      rewrite ^/tag\/(.*)/?$ https://wellcomecollection.org/articles?q=tags:$1 permanent;

      # pages
      rewrite ^/about/?$ https://wellcomecollection.org/what-we-do/about-wellcome-collection permanent;
      rewrite ^/about/terms-and-conditions/?$ https://wellcome.ac.uk/about-us/terms-use permanent;

      # index
      rewrite ^/?$ https://wellcomecollection.org/explore permanent;
    }
  }

  # v1 vs v2 testing
  upstream v1 {
    server prev.wellcomecollection.org;
  }
  upstream v2 {
    server wellcomecollection:3000;
  }
  split_clients "graphicdesign${remote_addr}${http_user_agent}${date_gmt}" $graphicdesign_split {
    50% 1;
    50% 2;
  }
  map $cookie_WC_graphicdesign $graphicdesign {
    ""      $graphicdesign_split;
    default $cookie_WC_graphicdesign;
  }
  map $graphicdesign $upstream_name {
    1 v1;
    2 v2;
  }

  server {
    listen           80;
    listen           443 ssl;
    server_name      wellcomecollection.org;
    add_header       x-wc-nginx-proxy true;
    add_header       Strict-Transport-Security max-age=10886400;

    gzip on;
    gzip_types text/css application/javascript;
    # See: http://webmasters.stackexchange.com/questions/31750/what-is-recommended-minimum-object-size-for-gzip-performance-benefits
    gzip_min_length 860;
    gzip_proxied any;

    # v1 vs v2 testing
    location ~ ^/graphicdesign {
      add_header Set-Cookie   "WC_graphicdesign=$graphicdesign;Path=/;Max-Age=86400";

      proxy_set_header        HTTP_X_FORWARDED_PROTO https;
      proxy_set_header        Host $host;
      proxy_pass              http://$upstream_name;
    }

    # These are the locations we know exist solely on v2
    location ~ ^/assets|/async|/explore|/works|/series|/preview {
      proxy_set_header        Host $host;
      proxy_pass              http://wellcomecollection:3000;
    }

    # For exhibitions, we default to v2 and fallback to v1
    # This is because drupal considers /exhibitions/anything/goes
    # to be a valid request
    location ~ ^/exhibitions/.* {
      proxy_set_header        Host $host;
      proxy_pass              http://wellcomecollection:3000;
      proxy_intercept_errors  on;
      error_page 404 = @v1;
    }

    # Everything else - if we 404 on v1, we fallback to v2
    location / {
      proxy_pass              http://prev.wellcomecollection.org;
      proxy_set_header        Host $host;
      proxy_set_header        HTTP_X_FORWARDED_PROTO https;
      proxy_intercept_errors  on;
      error_page 404 = @v2;
    }

    location @v1 {
      proxy_pass              http://prev.wellcomecollection.org;
      proxy_set_header        Host $host;
      proxy_set_header        HTTP_X_FORWARDED_PROTO https;
    }

    location @v2 {
      proxy_set_header        Host $host;
      proxy_pass              http://wellcomecollection:3000;
    }
  }

  # redirect http traffic
  # server {
  #   listen 80;
  #   server_name wellcomecollection.org;
  #   return 301 https://wellcomecollection.org$request_uri;
  # }

  # redirect next. traffic
  server {
    listen 80;
    listen 443 ssl;
    server_name next.wellcomecollection.org;
    return 301 https://wellcomecollection.org$request_uri;
  }

  # for now we just allow you through to the site
  #Â but we might want to always redirect to https://wellcomecollection.org
  server {
    listen      80 default_server;
    server_name _;
    add_header  x-wc-nginx-proxy true;

    location / {
      proxy_set_header Host $host;
      proxy_pass       http://wellcomecollection:3000;
    }
  }
}
