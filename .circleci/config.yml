version: 2.1
jobs:
  checkout_code:
    docker:
      - image: circleci/node:12.18.3
    working_directory: ~/wellcomecollection.org
    steps:
      - checkout
      - save_cache:
          key: repo_{{ .Environment.CACHE_VERSION }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            -  ~/wellcomecollection.org
  install_modules:
    docker:
      - image: circleci/node:12.18.3
    working_directory: ~/wellcomecollection.org
    steps:
      - restore_cache:
          key: repo_{{ .Environment.CACHE_VERSION }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: root_modules_circleci_node_10_{{ checksum "package.json" }}
      - run:
          name: Install root modules
          command: yarn install --production
      - save_cache:
          key: root_modules_circleci_node_10_{{ checksum "package.json" }}
          paths:
            -  node_modules
  type_check:
    docker:
      - image: circleci/node:12.18.3
    working_directory: ~/wellcomecollection.org
    steps:
      - restore_cache:
          key: repo_{{ .Environment.CACHE_VERSION }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: root_modules_circleci_node_10_{{ checksum "package.json" }}
      - run:
          name: Flow typecheck
          command: yarn flow
  common_tests:
    docker:
      - image: circleci/node:12.18.3
    working_directory: ~/wellcomecollection.org/common
    steps:
      - restore_cache:
          key: repo_{{ .Environment.CACHE_VERSION }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: root_modules_circleci_node_10_{{ checksum "package.json" }}
      - run:
          name: Yarn install
          command: yarn install
      - run:
          name: Test
          command: yarn test
  catalogue:
    docker:
      - image: circleci/node:12.18.3
    working_directory: ~/wellcomecollection.org/catalogue/webapp
    steps:
      - restore_cache:
          key: repo_{{ .Environment.CACHE_VERSION }}-{{ .Environment.CIRCLE_SHA1 }}
      - add_ssh_keys
      - setup_remote_docker
      - run:
          name: Yarn test
          command: yarn && yarn test
      - run:
          name: Docker build
          command: CONTAINER_TAG=${CIRCLE_SHA1} docker-compose build
      - run:
          name: Docker push
          command: |
            if [ "$CIRCLE_BRANCH" = "master" ];
            then
                docker login --username $DOCKER_USER --password $DOCKER_PASS
                CONTAINER_TAG=${CIRCLE_SHA1} docker-compose push
            fi
      - run:
          name: Install awscli
          command: sudo apt-get install awscli
      - run:
          name: Next report
          command: |
            yarn
            BUILD_HASH=${CIRCLE_SHA1} BUNDLE_ANALYZE=both yarn build
            pushd .dist
              cp browser.${CIRCLE_SHA1}.html catalogue.browser.latest.html
              cp browser.${CIRCLE_SHA1}.json catalogue.browser.latest.json
              cp server.${CIRCLE_SHA1}.html catalogue.server.latest.html
              cp server.${CIRCLE_SHA1}.json catalogue.server.latest.json
              aws s3 sync --only-show-errors . s3://dash.wellcomecollection.org/bundles
            popd
  content:
    docker:
      - image: circleci/node:12.18.3
    working_directory: ~/wellcomecollection.org/content/webapp
    steps:
      - restore_cache:
          key: repo_{{ .Environment.CACHE_VERSION }}-{{ .Environment.CIRCLE_SHA1 }}
      - add_ssh_keys
      - setup_remote_docker
      - run:
          name: Docker build
          command: CONTAINER_TAG=${CIRCLE_SHA1} docker-compose build
      - run:
          name: Docker push
          command: |
            if [ "$CIRCLE_BRANCH" = "master" ];
            then
                docker login --username $DOCKER_USER --password $DOCKER_PASS
                CONTAINER_TAG=${CIRCLE_SHA1} docker-compose push
            fi
      - run:
          name: Install awscli
          command: sudo apt-get install awscli
      - run:
          name: Next report
          command: |
            yarn
            BUILD_HASH=${CIRCLE_SHA1} BUNDLE_ANALYZE=both yarn build
            pushd .dist
              cp browser.${CIRCLE_SHA1}.html content.browser.latest.html
              cp browser.${CIRCLE_SHA1}.json content.browser.latest.json
              cp server.${CIRCLE_SHA1}.html content.server.latest.html
              cp server.${CIRCLE_SHA1}.json content.server.latest.json
              aws s3 sync --only-show-errors . s3://dash.wellcomecollection.org/bundles
            popd
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - checkout_code
      - install_modules:
          requires:
            - checkout_code
      - type_check:
          requires:
            - install_modules
      - common_tests:
          requires:
            - install_modules
      - catalogue:
          requires:
            - common_tests
            - type_check
      - content:
          requires:
            - common_tests
            - type_check
