- label: ":docker: build {{ matrix }}"
  key: "build_{{ matrix }}"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        build:
          - "{{ matrix }}"
        image-repository: 130871440101.dkr.ecr.eu-west-1.amazonaws.com/uk.ac.wellcome/buildkite

  matrix:
    - "common"
    - "catalogue"
    - "content"
    - "identity"
    - "edge_lambdas"

- label: "diff prismic model"
  branches: "main"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        run: prismic_model
        env:
          - CI
        command: ["yarn", "diffCustomTypes"]

- label: "test {{ matrix }}"
  key: "build_{{ matrix }}"
  depends_on: "build_{{ matrix }}"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        run: "{{ matrix }}"
        command: ["yarn", "test"]

  matrix:
    - "common"
    - "catalogue"
    - "content"
    - "identity"
    - "edge_lambdas"

- wait

- label: "deploy {{ matrix }} (ecr image)"
  branches: "main"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        push:
          - "{{ matrix }}:130871440101.dkr.ecr.eu-west-1.amazonaws.com/uk.ac.wellcome/{{ matrix }}_webapp:ref.${BUILDKITE_COMMIT}"
          - "{{ matrix }}:130871440101.dkr.ecr.eu-west-1.amazonaws.com/uk.ac.wellcome/{{ matrix }}_webapp:latest"

  matrix:
    - "catalogue"
    - "content"
    - "identity"

- label: "deploy catalogue (bundle analysis)"
  branches: "main"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        run: catalogue
        command: [ "yarn", "deployBundleAnalysis" ]
        env:
          - AWS_ACCESS_KEY_ID
          - AWS_SECRET_ACCESS_KEY
          - AWS_SESSION_TOKEN

- label: "deploy content (bundle analysis)"
  branches: "main"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        run: content
        command: [ "yarn", "deployBundleAnalysis" ]
        env:
          - AWS_ACCESS_KEY_ID
          - AWS_SECRET_ACCESS_KEY
          - AWS_SESSION_TOKEN

# - label: "deploy identity (bundle analysis)"
#   branches: "main"
#   plugins:
#     - wellcomecollection/aws-assume-role#v0.2.2:
#         role: "arn:aws:iam::130871440101:role/experience-ci"
#     - ecr#v2.1.1:
#         login: true
#     - docker-compose#v3.5.0:
#         run: identity
#         command: [ "yarn", "deployBundleAnalysis" ]
#         env:
#           - AWS_ACCESS_KEY_ID
#           - AWS_SECRET_ACCESS_KEY
#           - AWS_SESSION_TOKEN

- label: "deploy dash"
  branches: "main"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        run: dash
        command: [ "yarn", "deploy" ]
        env:
          - AWS_ACCESS_KEY_ID
          - AWS_SECRET_ACCESS_KEY
          - AWS_SESSION_TOKEN

- label: "deploy edge_lambdas"
  branches: "main"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        run: edge_lambdas
        command: [ "yarn", "deploy" ]
        env:
          - AWS_ACCESS_KEY_ID
          - AWS_SECRET_ACCESS_KEY
          - AWS_SESSION_TOKEN

- label: "deploy updown"
  branches: "main"
  skip: "To avoid overriding manual work that is occuring"
  plugins:
    - wellcomecollection/aws-assume-role#v0.2.2:
        role: "arn:aws:iam::130871440101:role/experience-ci"
    - ecr#v2.1.1:
        login: true
    - docker-compose#v3.5.0:
        run: updown
        command: [ "yarn", "checks" ]
        env:
          - AWS_ACCESS_KEY_ID
          - AWS_SECRET_ACCESS_KEY
          - AWS_SESSION_TOKEN

- label: "deploy assets"
  branches: "main"
  commands: ./assets/deploy_assets.sh
  agents:
    queue: nano

- wait

- label: "Trigger stage deployment"
  branches: "main"
  plugins:
    - wellcomecollection/github-deployments#v0.3.0:
        assume_role: "arn:aws:iam::130871440101:role/experience-ci"
        environment: stage
        ref: "${BUILDKITE_COMMIT}"
  agents:
    queue: nano
